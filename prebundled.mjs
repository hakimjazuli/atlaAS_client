class t{queue={};is_running=!1;assign=t=>{this.push(t),this.is_running||this.run()};push=t=>{const{callback:e,debounce:i}=t;this.queue[t.id]={callback:e,debounce:i}};timeout=t=>new Promise((e=>setTimeout(e,t)));is_async=t=>"AsyncFunction"===t.constructor.name;run=async()=>{for(this.is_running=!0;0!==Object.keys(this.queue).length;)for(const t in this.queue){const{callback:e,debounce:i}=this.queue[t];if(delete this.queue[t],i&&await this.timeout(i),!this.is_async(e)){e();break}await e()}this.is_running=!1}}class e{constructor(t,e,i=!1){this.id=t,this.callback=e,this.debounce=i}id;callback;debounce}class i extends t{static __;constructor(){super(),i.__=this}}class n{el;constructor(t){this.el=t}outerHTML=t=>{this.el&&(this.el.outerHTML=t)};innerHTML=t=>(this.el&&(this.el.innerHTML=t),this);innerText=t=>(this.el&&this.el instanceof HTMLElement&&(this.el.innerText=t),this);textContent=t=>(this.el&&(this.el.textContent=t),this);value=t=>(this.el&&this.el instanceof HTMLInputElement&&(this.el.value=t),this);styles=t=>{if(this.el&&this.el instanceof HTMLElement)for(const e in t)this.el.style[e]=t[e];return this};classList=t=>{if(this.el)for(const e in t)for(let i=0;i<t[e].length;i++)this.el.classList[e](t[e][i]);return this};append=t=>(this.el&&this.el.appendChild(t),this);prepend=t=>(this.el&&this.el.prepend(t),this);before=t=>{if(this.el){if(!this.el.parentNode)return;this.el.parentNode.insertBefore(t,this.el)}return this};after=t=>(this.el&&this.el.insertAdjacentElement("afterend",t),this);attributes=t=>{if(this.el)if(t instanceof NamedNodeMap)for(let e=0;e<t.length;e++){const{name:i,value:n}=t[e];"true"===n?this.el.setAttribute(i,""):"false"===n?this.el.removeAttribute(i):this.el.setAttribute(i,n)}else for(const e in t){const i=t[e];!0===i?this.el.setAttribute(e,""):!1===i?this.el.removeAttribute(e):this.el.setAttribute(e,i)}return this};replace=t=>{if(this.el){if(!this.el.parentNode)return;this.el.parentNode.replaceChild(t,this.el)}};script=async t=>(this.el&&await t(this.el),this)}class a{static __;constructor(){a.__=this}first_hydration=!0;separator=[";"];a_controller="a-controller";a_debounce="a-debounce";debounce_default="0";controllers_default="self";a_trigger="a-trigger";a_confirm="a-confirm";trigger_default="click";lazy_trigger="lazy";lazy_identifier="a-lazy";a_loading="a-loading";a_request_path="a-path";a_view="a-view";a_timeout="a-timeout";a_method="a-method";a_partial="a-";method_default="get";a_failed_text="a-failed_text";a_failed_text_default="fetch failed";a_failed_attr="a-failed";a_token_name="a-token_name";a_token_value="a-token_value";a_keep="a-keep";load_identifier="a:load";route_change_identifier="a:route_changes";route_change_id="a-route_change_indicator";client_reroute_key="reroute";csrf_starts_with="csrf_";atlaAS_client_request_header="atlaAS-client-from";a_on_loading_attributes="a-on_loading";notify_load=(t,e)=>{window.dispatchEvent(new CustomEvent(this.load_identifier,{detail:{affected_node:t,mode:e,first_hydration:this.first_hydration}}))}}class r{set_attributes=t=>{new n(t).attributes({id:a.__.route_change_id,ariaBusy:"true"}).styles({position:"fixed",margin:"0",padding:"0",zIndex:"9999",width:"100%",top:"0",left:"0",visibility:"hidden"})};element=()=>document.getElementById(a.__.route_change_id);static __;constructor(){this.create_progress_bar(),this.__=this}create_progress_bar=()=>{let t=this.element();if(t)return void(this.progress_bar=t);const e=document.createElement("progress");this.set_attributes(e),new n(document.body).prepend(e)}}class s{static timeout=t=>new Promise(((e,i)=>{setTimeout((()=>{i(new Error("Operation timed out"))}),t)}));static timeout_check=async(t,e)=>{let i;try{i=await Promise.race([t(),s.timeout(e)])}catch(t){i=!1}return i};static is_visible=t=>{const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)};static get_query_param=t=>new URL(`${window.location.origin}${t}`).searchParams;static push_state=t=>{t!==`${window.location.href}`&&history.pushState({},"",t)}}class o{static element_fetch=async(t,e)=>t.hasAttribute(a.__.a_timeout)?s.timeout_check((async()=>this.element_fetch_(t,e)),Number(t.getAttribute(a.__.a_timeout))):await this.element_fetch_(t,e);static element_fetch_=async(t,e)=>{try{const i=a.__;let n=t.getAttribute(i.a_method)??i.method_default;n=n.toUpperCase();const r=t.getAttribute(i.a_request_path)??"";let s,l={};if("GET"!==n){if(s=t instanceof HTMLFormElement?new FormData(t):new FormData,t.hasAttribute(i.a_token_name)&&t.hasAttribute(i.a_token_value)){const e=t.getAttribute(i.a_token_name)??"",n=t.getAttribute(i.a_token_value)??"";s.append(`${i.csrf_starts_with}${e}`,n)}l.body=s}return await o.base_fetch(r,!e||"query_only",l)}catch(t){return console.error("Fetch error:",t),"error"}};static base_fetch=async(t,e,i={},n=null,r="get")=>{const o=document.body;return o.hasAttribute(a.__.a_timeout)?s.timeout_check((async()=>this.base_fetch_(t,e,i,n,r)),Number(o.getAttribute(a.__.a_timeout))):await this.base_fetch_(t,e,i,n,r)};static base_fetch_=async(t,e,i={},n=null,r="get")=>{const o=a.__,_=s.get_query_param(t);if(i=Object.assign({method:r,Credential:"includes",headers:{[o.atlaAS_client_request_header]:window.location.href}},i),"get"===r&&"body"in i&&i.body instanceof FormData)for(const t in i.body)t.startsWith(o.csrf_starts_with)||_.append(t,i.body[t]);switch(e){case!0:s.push_state(`${t.split("?")[0]}${_.size?"?"+_.toString():""}`);break;case"query_only":s.push_state(`${window.location.origin}${window.location.pathname}${_.size?"?"+_.toString():""}`)}const c=await fetch(t,i);c.ok||console.error({response:c,request_path:t,method:r});if("application/json"===c.headers.get("Content-Type")){const t=await c.json();return t[o.client_reroute_key]&&await l.__.handle_route_change(t[o.client_reroute_key]),!1}return await c.text()}}class l{static __;constructor(){this.url=new URL(`${window.location.href}#${window.location.hash}`),l.__=this}handle_route_change=async t=>{const e=a.__;let i;if(t instanceof HTMLAnchorElement){const n=t.getAttribute(e.a_request_path)??"";if(this.url.href===n)return;this.url.href=`${window.location.origin}${n}`,n.includes("#")?this.handle_hash_change(n):i=await o.element_fetch(t,!1)}else{if(this.url.href===t)return;this.url.href=`${window.location.origin}${t}`,t.includes("#")?this.handle_hash_change(t):i=await o.base_fetch(t,!0)}i?this.render_route_change(i):this.render_failed_fetch()};url;pop_state_handle=async t=>{t.preventDefault();const e=window.location;if(this.url.href===e.href)return;const i=document.getElementById(a.__.route_change_id);if(new n(i).styles({visibility:"visible"}),this.url=new URL(`${e.href}#${e.hash}`),this.url.hash)return void this.handle_hash_change(this.url.hash);const r=await o.base_fetch(this.url.href,!1);r&&this.render_route_change(r)};handle_hash_change=t=>{if(s.push_state(`${window.location.href}#${t}`),!t)return;if("scroll_top"===t)return void window.scrollTo({top:0,behavior:"smooth"});const e=document.getElementById(t);e&&e.scrollIntoView({behavior:"smooth"})};render_route_change=t=>{const e=(new DOMParser).parseFromString(t,"text/html");this.handle_head(e.head),this.handle_body(e.body),a.__.notify_load(document,"after")};attr_h_b_=(t,e)=>{const i=document[e],a=new n(i);for(let e=0;e<i.attributes.length;e++){const{name:n,value:r}=i.attributes[e];t.hasAttribute(n)?t.getAttribute(n)!==r&&a.attributes({[n]:r}):a.attributes({[n]:!1})}for(let e=0;e<t.attributes.length;e++){const{name:n,value:r}=t.attributes[e];i.hasAttribute(n)&&i.getAttribute(n)!==r&&a.attributes({[n]:r})}};handle_head=t=>{const e=document.head.querySelectorAll("script"),i=document.head;this.attr_h_b_(t,"head");const n=Array.from(t.children),a=Array.from(i.children);a.forEach((t=>{const e=t.outerHTML;let a=!1;for(let t=0;t<n.length;t++){if(n[t].outerHTML==e){a=!0;break}}a||i.removeChild(t)})),n.forEach((t=>{const e=t.outerHTML;let n=!0;for(let t=0;t<a.length;t++){if(a[t].outerHTML==e){n=!1;break}}n&&i.appendChild(t)})),this.handle_scripts("head",e)};handle_body=t=>{const e=document.body.querySelectorAll("script");this.attr_h_b_(t,"body");const i=a.__.a_keep,s=t.querySelectorAll(`[${i}]`);if(s)for(let t=0;t<s.length;t++){const e=s[t];if(e.hasAttribute(i)){const t=document.body.querySelector(`[${i}="${e.getAttribute(i)}"]`);t&&new n(e).replace(t)}}new n(document.body).innerHTML(t.innerHTML),new r,this.handle_scripts("body",e)};handle_scripts=(t,e)=>{const i=document[t],n=i.querySelectorAll(`${t} script`);if(!n)return;const a=document.createElement("div");if(e){let t="";e.forEach((e=>{t+=e.outerHTML})),a.innerHTML=t}for(let t=0;t<n.length;t++){const e=n[t];e instanceof HTMLScriptElement&&this.re_run_script(e,a,i)}a.remove()};re_run_script=(t,e,i)=>{if(t.hasAttribute("src")&&t.hasAttribute(a.__.a_keep)&&e.querySelector(`[src="${t.getAttribute("src")}"]`))return;const r=document.createElement("script");new n(r).attributes(t.attributes).innerHTML(t.innerHTML),i.appendChild(r),t.remove()};render_failed_fetch=async()=>{alert("failed to fetch new page")}}class _{static __;constructor(){_.__=this}}class c{static logic=async(t,e)=>{const i=a.__;t.hasAttribute(i.a_confirm)&&!confirm(t.getAttribute(i.a_confirm)??"")||(t.hasAttribute(i.lazy_identifier)?await this.lazy():(await u.set_element_loading(t),await this.standard(t,e),await u.set_element_loading(t,!1)))};static standard=async(t,e)=>{const i=new d.__._ajax_renderer(e,t);await i.render()};static lazy=async()=>{const t=a.__,e=Array.from(document.querySelectorAll(`[${t.lazy_identifier}]`)).filter((t=>s.is_visible(t)));if(!e.length)return;let i=[];for(let n=0;n<e.length;n++){const a=e[n];i.push((async()=>{await u.set_element_loading(a);const e=new d.__._ajax_renderer(a.getAttribute(t.a_controller)??"",a);await e.render(),await u.set_element_loading(a,!1)}))}await Promise.all(i.map((async t=>await t()))).catch((t=>{console.error(t)}))}}class h{count=0;constructor(){}}class u{static default_trigger=t=>t instanceof HTMLAnchorElement?"click":t instanceof HTMLFormElement?"submit":a.__.trigger_default;static assign_event=(t,e)=>{const i=a.__,r=(t.getAttribute(i.a_trigger)??u.default_trigger(t)).split(i.separator[0]);r[0]===i.lazy_trigger&&new n(t).attributes({[i.lazy_identifier]:!0}),u.handle_trigger(t,r,e)};static handle_trigger=(t,e,i)=>{if(!t.parentElement)return;const n=e[0],a=d.__._triggers;n in a?(e.shift(),a[n](t,i,...e)):a.default(t,i,...e)};static popstate_listener=()=>{window.addEventListener("popstate",(t=>i.__.assign(new e(a.__.route_change_identifier,(async()=>{await l.__.pop_state_handle(t)})))))};static set_main_listeners=()=>{u.anchor_view(),u.form_view(),u.register_events(),a.__.first_hydration&&(a.__.first_hydration=!1)};static anchor_view=()=>{let t;for(;t=document.querySelector("a[href]");)u.set_defaults(t),new n(t).attributes({href:!1})};static form_view=()=>{let t;for(;t=document.querySelector("form[action]");){const e=new n(t);e.attributes({onsubmit:"event.preventDefault();"}),u.set_defaults(t),e.attributes({action:!1})}};static register_events=()=>{const t=a.__,r=t.a_trigger;let s;for(;s=document.querySelector(`[${t.a_trigger}]`);){const a=s,o=a.getAttribute(t.a_controller)??t.controllers_default,l=a.getAttribute(t.a_debounce)??t.debounce_default,_=new h;u.assign_event(a,((t=null,n=-1)=>(i.__.assign(new e(o,(async()=>{_.count!=n&&(await c.logic(a,o),n>=0&&_.count++)}),Number(l).valueOf())),_))),new n(s).attributes({[r]:!1}),t.notify_load(s,"after")}};static set_defaults=t=>{const e=a.__.a_trigger,i=a.__.a_method,r=a.__.a_controller,s=new n(t);let o,l={};t instanceof HTMLAnchorElement?l[a.__.a_request_path]=t.getAttribute("href")??"":t instanceof HTMLFormElement&&(l[a.__.a_request_path]=t.getAttribute("action")??""),t.hasAttribute(r)||(l[r]=`${a.__.controllers_default};`),t.hasAttribute(e)||(l[e]=u.default_trigger(t)),(o=t.getAttribute("method")??a.__.method_default)&&(l[i]=o),s.attributes(l)};static set_element_loading=async(t,e=!0)=>{if(!t)return;const i=a.__;let n;for(t.hasAttribute(i.a_on_loading_attributes)&&await this.handle_on_loading(t,e);n=t.querySelector(`[${i.a_on_loading_attributes}]`);)await this.handle_on_loading(n,e)};static handle_on_loading=async(t,e)=>{const i=a.__.a_on_loading_attributes,r=new n(t);if(!e)return void r.attributes({[i]:!1});r.attributes({[i]:!0});const s=t.getAttribute(i)??"",o=_.__[s]??window[i][s];o&&await o(r)}}class d{static __;_ajax_renderer;__progress_bar;_triggers;constructor(t,e,n,a,r){new t,new a,this._ajax_renderer=e,this._triggers=r,new i,new l,this.__progress_bar=new n,d.__=this}run=()=>{u.popstate_listener();const t=u.set_main_listeners;window.addEventListener(a.__.load_identifier,t),t()}}class f{static lazy_tick=(t,e,...i)=>{f.lazy(t,(()=>f.tick(t,e,...i)))};static lazy=(t,e)=>{const i=new IntersectionObserver((n=>{n.forEach((async n=>{n.isIntersecting&&(e(),i.unobserve(t))}))}));i.observe(t);const n=new MutationObserver((()=>{i.disconnect(),n.disconnect()}));n.observe(t.parentElement,{childList:!0})};static tick=(t,e,...i)=>{let[n,a]=i,r=Number(a)??1;const s=setInterval((()=>{e(null,r).count!=r&&t.parentElement||clearInterval(s)}),new Number(n).valueOf())};static default=(t,e,...i)=>{t.addEventListener(i[0],e),new MutationObserver((()=>{t.parentElement||t.removeEventListener(i[0],e)}))}}new d(a,class{controller;element;constructor(t,e){this.controller=t,this.element=e}render=async()=>{const t=a.__;if(this.element instanceof HTMLAnchorElement&&!this.element.hasAttribute(t.a_partial)){const e=document.getElementById(t.route_change_id);return e&&new n(e).styles({visibility:"visible"}),void await l.__.handle_route_change(this.element)}await this.controll()};controll=async()=>{const t=a.__,e=this.controller.split(t.separator[0]);for(let i=0;i<e.length;i++){const n=e[i];if(""===n)continue;if(n===t.controllers_default){await this.handle_view(this.element);continue}const a=document.querySelectorAll(`[${t.a_view}*="{${n}}"]`);if(a){let t=[];for(let e=0;e<a.length;e++){const i=a[e];t.push((async()=>{await this.handle_view(i)}))}await Promise.all(t.map((async t=>await t()))).catch((t=>{console.error(t)}))}}};handle_view=async t=>{await u.set_element_loading(t);const e=await o.element_fetch(t,!0);"string"==typeof e?(new n(t).outerHTML(e),a.__.notify_load(t,"before")):this.render_failed_fetch(t),await u.set_element_loading(t,!1)};render_failed_fetch=async t=>{const e=a.__;new n(t).attributes({[e.a_failed_attr]:!0}).innerText(t.getAttribute(e.a_failed_text)??e.a_failed_text_default)}},r,_,f).run();
