class t{constructor(t,e,n=!1){this.id=t,this.callback=e,this.debounce=n}id;callback;debounce}class e{static timeout=t=>new Promise((e=>setTimeout(e,t)));static is_async=t=>"AsyncFunction"===t.constructor.name}class n{queue={};is_running=!1;assign=t=>{this.push(t),this.is_running||this.run()};push=t=>{const{callback:e,debounce:n}=t;this.queue[t.id]={callback:e,debounce:n}};run=async()=>{for(this.is_running=!0;0!==Object.keys(this.queue).length;)for(const t in this.queue){const{callback:n,debounce:i}=this.queue[t];if(delete this.queue[t],i&&await e.timeout(i),e.is_async(n)){await n();break}n();break}this.is_running=!1}}class i extends n{static __;constructor(){super(),i.__=this}}class a{el;constructor(t){this.el=t}outerHTML=t=>{this.el&&(this.el.outerHTML=t)};innerHTML=t=>(this.el&&(this.el.innerHTML=t),this);innerText=t=>(this.el&&this.el instanceof HTMLElement&&(this.el.innerText=t),this);textContent=t=>(this.el&&(this.el.textContent=t),this);value=t=>(this.el&&this.el instanceof HTMLInputElement&&(this.el.value=t),this);styles=t=>{if(this.el&&this.el instanceof HTMLElement)for(const e in t)this.el.style[e]=t[e];return this};classList=t=>{if(this.el)for(const e in t)for(let n=0;n<t[e].length;n++)this.el.classList[e](t[e][n]);return this};append=t=>(this.el&&this.el.appendChild(t),this);prepend=t=>(this.el&&this.el.prepend(t),this);before=t=>{if(this.el){if(!this.el.parentNode)return;this.el.parentNode.insertBefore(t,this.el)}return this};after=t=>(this.el&&this.el.insertAdjacentElement("afterend",t),this);attributes=t=>{if(this.el)if(t instanceof NamedNodeMap)for(let e=0;e<t.length;e++){const{name:n,value:i}=t[e];"true"===i?this.el.setAttribute(n,""):"false"===i?this.el.removeAttribute(n):this.el.setAttribute(n,i)}else for(const e in t){const n=t[e];!0===n?this.el.setAttribute(e,""):!1===n?this.el.removeAttribute(e):this.el.setAttribute(e,n)}return this};replace=t=>{if(this.el){if(!this.el.parentNode)return;this.el.parentNode.replaceChild(t,this.el)}};script=async t=>(this.el&&await t(this.el),this)}class r{static __;constructor(){r.__=this}first_hydration=!0;separator=[";"];a_controller="a-controller";a_debounce="a-debounce";debounce_default="0";controllers_default="self";a_trigger="a-trigger";a_confirm="a-confirm";trigger_default="click";lazy_trigger="lazy";lazy_identifier="a-lazy";a_loading="a-loading";a_request_path="a-path";a_view="a-view";a_timeout="a-timeout";a_method="a-method";a_partial="a-";method_default="get";a_failed_text="a-failed_text";a_failed_text_default="fetch failed";a_failed_attr="a-failed";a_token_name="a-token_name";a_token_value="a-token_value";a_keep="a-keep";load_identifier="a:load";route_change_identifier="a:route_changes";route_change_id="a-route_change_indicator";client_reroute_key="reroute";csrf_starts_with="csrf_";atlaAS_client_request_header="atlaAS-client-from";a_on_loading_attributes="a-on_loading";notify_load=(t,e)=>{window.dispatchEvent(new CustomEvent(this.load_identifier,{detail:{affected_node:t,mode:e,first_hydration:this.first_hydration}}))}}class s{set_attributes=t=>{new a(t).attributes({id:r.__.route_change_id,ariaBusy:"true"}).styles({position:"fixed",margin:"0",padding:"0",zIndex:"9999",width:"100%",top:"0",left:"0",visibility:"hidden"})};element=()=>document.getElementById(r.__.route_change_id);static __;constructor(){this.create_progress_bar(),this.__=this}create_progress_bar=()=>{let t=this.element();if(t)return void(this.progress_bar=t);const e=document.createElement("progress");this.set_attributes(e),new a(document.body).prepend(e)}}class o{static timeout=t=>new Promise(((e,n)=>{setTimeout((()=>{n(new Error("Operation timed out"))}),t)}));static timeout_check=async(t,e)=>{let n;try{n=await Promise.race([t(),o.timeout(e)])}catch(t){n=!1}return n};static is_visible=t=>{const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)};static get_query_param=t=>new URL(`${window.location.origin}${t}`).searchParams;static push_state=t=>{t!==`${window.location.href}`&&history.pushState({},"",t)}}class l{static element_fetch=async(t,e)=>t.hasAttribute(r.__.a_timeout)?o.timeout_check((async()=>this.element_fetch_(t,e)),Number(t.getAttribute(r.__.a_timeout))):await this.element_fetch_(t,e);static element_fetch_=async(t,e)=>{try{const n=r.__;let i=t.getAttribute(n.a_method)??n.method_default;i=i.toUpperCase();const a=t.getAttribute(n.a_request_path)??"";let s,o={};if("GET"!==i){if(s=t instanceof HTMLFormElement?new FormData(t):new FormData,t.hasAttribute(n.a_token_name)&&t.hasAttribute(n.a_token_value)){const e=t.getAttribute(n.a_token_name)??"",i=t.getAttribute(n.a_token_value)??"";s.append(`${n.csrf_starts_with}${e}`,i)}o.body=s}return await l.base_fetch(a,!e||"query_only",o)}catch(t){return console.error("Fetch error:",t),"error"}};static base_fetch=async(t,e,n={},i=null,a="get")=>{const s=document.body;return s.hasAttribute(r.__.a_timeout)?o.timeout_check((async()=>this.base_fetch_(t,e,n,i,a)),Number(s.getAttribute(r.__.a_timeout))):await this.base_fetch_(t,e,n,i,a)};static base_fetch_=async(t,e,n={},i=null,a="get")=>{const s=r.__,l=o.get_query_param(t);if(n=Object.assign({method:a,Credential:"includes",headers:{[s.atlaAS_client_request_header]:window.location.href}},n),"get"===a&&"body"in n&&n.body instanceof FormData)for(const t in n.body)t.startsWith(s.csrf_starts_with)||l.append(t,n.body[t]);switch(e){case!0:o.push_state(`${t.split("?")[0]}${l.size?"?"+l.toString():""}`);break;case"query_only":o.push_state(`${window.location.origin}${window.location.pathname}${l.size?"?"+l.toString():""}`)}const c=await fetch(t,n);c.ok||console.error({response:c,request_path:t,method:a});if("application/json"===c.headers.get("Content-Type")){const t=await c.json();return t[s.client_reroute_key]&&await _.__.handle_route_change(t[s.client_reroute_key]),!1}return await c.text()}}class _{static __;constructor(){this.url=new URL(`${window.location.href}#${window.location.hash}`),_.__=this}handle_route_change=async t=>{const e=r.__;let n;if(t instanceof HTMLAnchorElement){const i=t.getAttribute(e.a_request_path)??"";if(this.url.href===i)return;this.url.href=`${window.location.origin}${i}`,i.includes("#")?this.handle_hash_change(i):n=await l.element_fetch(t,!1)}else{if(this.url.href===t)return;this.url.href=`${window.location.origin}${t}`,t.includes("#")?this.handle_hash_change(t):n=await l.base_fetch(t,!0)}n?this.render_route_change(n):this.render_failed_fetch()};url;pop_state_handle=async t=>{t.preventDefault();const e=window.location;if(this.url.href===e.href)return;const n=document.getElementById(r.__.route_change_id);if(new a(n).styles({visibility:"visible"}),this.url=new URL(`${e.href}#${e.hash}`),this.url.hash)return void this.handle_hash_change(this.url.hash);const i=await l.base_fetch(this.url.href,!1);i&&this.render_route_change(i)};handle_hash_change=t=>{if(o.push_state(`${window.location.href}#${t}`),!t)return;if("scroll_top"===t)return void window.scrollTo({top:0,behavior:"smooth"});const e=document.getElementById(t);e&&e.scrollIntoView({behavior:"smooth"})};render_route_change=t=>{const e=(new DOMParser).parseFromString(t,"text/html");this.handle_head(e.head),this.handle_body(e.body),r.__.notify_load(document,"after")};attr_h_b_=(t,e)=>{const n=document[e],i=new a(n);for(let e=0;e<n.attributes.length;e++){const{name:a,value:r}=n.attributes[e];t.hasAttribute(a)?t.getAttribute(a)!==r&&i.attributes({[a]:r}):i.attributes({[a]:!1})}for(let e=0;e<t.attributes.length;e++){const{name:a,value:r}=t.attributes[e];n.hasAttribute(a)&&n.getAttribute(a)!==r&&i.attributes({[a]:r})}};handle_head=t=>{const e=document.head.querySelectorAll("script"),n=document.head;this.attr_h_b_(t,"head");const i=Array.from(t.children),a=Array.from(n.children);a.forEach((t=>{const e=t.outerHTML;let a=!1;for(let t=0;t<i.length;t++){if(i[t].outerHTML==e){a=!0;break}}a||n.removeChild(t)})),i.forEach((t=>{const e=t.outerHTML;let i=!0;for(let t=0;t<a.length;t++){if(a[t].outerHTML==e){i=!1;break}}i&&n.appendChild(t)})),this.handle_scripts("head",e)};handle_body=t=>{const e=document.body.querySelectorAll("script");this.attr_h_b_(t,"body");const n=r.__.a_keep,i=t.querySelectorAll(`[${n}]`);if(i)for(let t=0;t<i.length;t++){const e=i[t];if(e.hasAttribute(n)){const t=document.body.querySelector(`[${n}="${e.getAttribute(n)}"]`);t&&new a(e).replace(t)}}new a(document.body).innerHTML(t.innerHTML),new s,this.handle_scripts("body",e)};handle_scripts=(t,e)=>{const n=document[t],i=n.querySelectorAll(`${t} script`);if(!i)return;const a=document.createElement("div");if(e){let t="";e.forEach((e=>{t+=e.outerHTML})),a.innerHTML=t}for(let t=0;t<i.length;t++){const e=i[t];e instanceof HTMLScriptElement&&this.re_run_script(e,a,n)}a.remove()};re_run_script=(t,e,n)=>{if(t.hasAttribute("src")&&t.hasAttribute(r.__.a_keep)&&e.querySelector(`[src="${t.getAttribute("src")}"]`))return;const i=document.createElement("script");new a(i).attributes(t.attributes).innerHTML(t.innerHTML),n.appendChild(i),t.remove()};render_failed_fetch=async()=>{alert("failed to fetch new page")}}class c{static __;constructor(){c.__=this}}class h{static logic=async(t,e)=>{const n=r.__;if(t.hasAttribute(n.a_confirm)&&!confirm(t.getAttribute(n.a_confirm)??""))return;if(t.hasAttribute(n.lazy_identifier))return void await this.lazy();const i=new a(t);d.set_element_loading(i),await d.handle_on_loadings(t),await this.standard(t,e),d.set_element_loading(i,!1)};static standard=async(t,e)=>{const n=new f.__._ajax_renderer(e,t);await n.render()};static lazy=async()=>{const t=r.__,e=Array.from(document.querySelectorAll(`[${t.lazy_identifier}]`)).filter((t=>o.is_visible(t)));if(!e.length)return;let n=[];for(let i=0;i<e.length;i++){const r=e[i];n.push((async()=>{const e=new a(r);d.set_element_loading(e),await d.handle_on_loadings(r);const n=new f.__._ajax_renderer(r.getAttribute(t.a_controller)??"",r);await n.render(),d.set_element_loading(e,!1)}))}await Promise.all(n.map((async t=>await t()))).catch((t=>{console.error(t)}))}}class u{count=0;constructor(){}}class d{static default_trigger=t=>t instanceof HTMLAnchorElement?"click":t instanceof HTMLFormElement?"submit":r.__.trigger_default;static assign_event=(t,e)=>{const n=r.__,i=(t.getAttribute(n.a_trigger)??d.default_trigger(t)).split(n.separator[0]);i[0]===n.lazy_trigger&&new a(t).attributes({[n.lazy_identifier]:!0}),d.handle_trigger(t,i,e)};static handle_trigger=(t,e,n)=>{if(!t.parentElement)return;const i=e[0],a=f.__._triggers;i in a?(e.shift(),a[i](t,n,...e)):a.default(t,n,...e)};static popstate_listener=()=>{window.addEventListener("popstate",(e=>i.__.assign(new t(r.__.route_change_identifier,(async()=>{await _.__.pop_state_handle(e)})))))};static set_main_listeners=()=>{d.anchor_view(),d.form_view(),d.register_events(),r.__.first_hydration&&(r.__.first_hydration=!1)};static anchor_view=()=>{let t;for(;t=document.querySelector("a[href]");)d.set_defaults(t),new a(t).attributes({href:!1})};static form_view=()=>{let t;for(;t=document.querySelector("form[action]");){const e=new a(t);e.attributes({onsubmit:"event.preventDefault();"}),d.set_defaults(t),e.attributes({action:!1})}};static register_events=()=>{const e=r.__,n=e.a_trigger;let s;for(;s=document.querySelector(`[${e.a_trigger}]`);){const r=s,o=r.getAttribute(e.a_controller)??e.controllers_default,l=r.getAttribute(e.a_debounce)??e.debounce_default,_=new u;d.assign_event(r,((e=null,n=-1)=>(i.__.assign(new t(o,(async()=>{_.count!=n&&(await h.logic(r,o),n>=0&&_.count++)}),Number(l).valueOf())),_))),new a(s).attributes({[n]:!1}),e.notify_load(s,"after")}};static set_defaults=t=>{const e=r.__.a_trigger,n=r.__.a_method,i=r.__.a_controller,s=new a(t);let o,l={};t instanceof HTMLAnchorElement?l[r.__.a_request_path]=t.getAttribute("href")??"":t instanceof HTMLFormElement&&(l[r.__.a_request_path]=t.getAttribute("action")??""),t.hasAttribute(i)||(l[i]=`${r.__.controllers_default};`),t.hasAttribute(e)||(l[e]=d.default_trigger(t)),(o=t.getAttribute("method")??r.__.method_default)&&(l[n]=o),s.attributes(l)};static handle_on_loadings=async t=>{if(!t)return;const e=r.__.a_on_loading_attributes;let n;for(t.hasAttribute(e)&&await this.handle_on_loading_single(t);n=t.querySelector(`[${e}]`);)await this.handle_on_loading_single(n)};static handle_on_loading_single=async t=>{const e=r.__.a_on_loading_attributes,n=new a(t),i=t.getAttribute(e)??"",s=c.__[i]??window[e][i];s&&await s(n)};static set_element_loading=(t,e=!0)=>{e?t.attributes({[r.__.a_loading]:!0}):t.attributes({[r.__.a_loading]:!1})}}class f{static __;_ajax_renderer;__progress_bar;_triggers;constructor(t,e,n,a,r){new t,new a,this._ajax_renderer=e,this._triggers=r,new i,new _,this.__progress_bar=new n,f.__=this}run=()=>{d.popstate_listener();const t=d.set_main_listeners;window.addEventListener(r.__.load_identifier,t),t()}}class g{static lazy_tick=(t,e,...n)=>{g.lazy(t,(()=>g.tick(t,e,...n)))};static lazy=(t,e)=>{const n=new IntersectionObserver((i=>{i.forEach((async i=>{i.isIntersecting&&(e(),n.unobserve(t))}))}));n.observe(t);const i=new MutationObserver((()=>{n.disconnect(),i.disconnect()}));i.observe(t.parentElement,{childList:!0})};static tick=(t,e,...n)=>{let[i,a]=n,r=Number(a)??1;const s=setInterval((()=>{e(null,r).count!=r&&t.parentElement||clearInterval(s)}),new Number(i).valueOf())};static default=(t,e,...n)=>{t.addEventListener(n[0],e),new MutationObserver((()=>{t.parentElement||t.removeEventListener(n[0],e)}))}}new f(r,class{controller;element;constructor(t,e){this.controller=t,this.element=e}render=async()=>{const t=r.__;if(this.element instanceof HTMLAnchorElement&&!this.element.hasAttribute(t.a_partial)){const e=document.getElementById(t.route_change_id);return e&&new a(e).styles({visibility:"visible"}),void await _.__.handle_route_change(this.element)}await this.controll()};controll=async()=>{const t=r.__,e=this.controller.split(t.separator[0]);for(let n=0;n<e.length;n++){const i=e[n];if(""===i)continue;if(i===t.controllers_default){await this.handle_view(this.element);continue}const a=document.querySelectorAll(`[${t.a_view}*="{${i}}"]`);if(a){let t=[];for(let e=0;e<a.length;e++){const n=a[e];t.push((async()=>{await this.handle_view(n)}))}await Promise.all(t.map((async t=>await t()))).catch((t=>{console.error(t)}))}}};handle_view=async t=>{const e=new a(t);d.set_element_loading(e),await d.handle_on_loadings(t);const n=await l.element_fetch(t,!0);"string"==typeof n?(new a(t).outerHTML(n),r.__.notify_load(t,"before")):this.render_failed_fetch(t),d.set_element_loading(e,!1)};render_failed_fetch=async t=>{const e=r.__;new a(t).attributes({[e.a_failed_attr]:!0}).innerText(t.getAttribute(e.a_failed_text)??e.a_failed_text_default)}},s,c,g).run();
